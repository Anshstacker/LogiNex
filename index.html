<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogiNex - Definitive Prototype (Fully Functional)</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- Design System & Variables --- */
        :root {
            --bg-dark: #0a092d;
            --bg-light: #101c42;
            --primary: #00fddc; 
            --primary-glow: rgba(0, 253, 220, 0.4);
            --secondary: #9e77f8;
            --accent-pink: #ff3b81;
            --text-primary: #ffffff;
            --text-secondary: #a9b2d8;
            --border-color: rgba(169, 178, 216, 0.1);
            --glass-bg: rgba(16, 28, 66, 0.6);
            --shadow: 0px 8px 32px rgba(0, 0, 0, 0.2);
            --success: #00e676;
            --warning: #ffc107;
        }

        /* --- Base & Reset --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            overflow-x: hidden;
        }
        .hidden { display: none !important; }

        /* --- Login Page --- */
        .login-wrapper {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-dark);
        }
        
        .login-container {
            position: relative;
            padding: 40px;
            text-align: center;
            width: 90%;
            max-width: 420px;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }
        .login-container h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        .login-container p { color: var(--text-secondary); margin-bottom: 32px; }
        .login-container .input-group { margin-bottom: 20px; text-align: left; }
        .login-container input {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 14px;
            font-size: 16px;
            color: var(--text-primary);
        }
        .login-container input::placeholder { color: var(--text-secondary); }
        .login-container button {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: var(--bg-dark);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px var(--primary-glow);
        }
        .login-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px var(--primary-glow);
        }
        .error-message { color: var(--accent-pink); min-height: 20px; font-size: 14px; margin-top: 16px; }

        /* --- Main App Layout --- */
        .app-layout {
            display: grid;
            grid-template-columns: 260px 1fr;
            min-height: 100vh;
        }
        .sidebar {
            background: var(--bg-light);
            border-right: 1px solid var(--border-color);
            padding: 32px 24px;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header { font-size: 28px; font-weight: 700; color: var(--primary); margin-bottom: 48px; }
        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
            text-decoration: none;
            padding: 14px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .sidebar-nav a .icon {
            width: 20px;
            height: 20px;
        }
        .sidebar-nav a.active, .sidebar-nav a:hover { background: var(--glass-bg); color: var(--text-primary); }
        .sidebar-footer { margin-top: auto; }
        #logout-btn {
            width: 100%;
            background: transparent;
            border: 1px solid var(--accent-pink);
            color: var(--accent-pink);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .main-content { padding: 32px; overflow-y: auto; }
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
        .main-header h2 { font-size: 28px; font-weight: 600; }
        .primary-action-btn {
            background: var(--primary);
            color: var(--bg-dark);
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px var(--primary-glow);
        }
        .primary-action-btn:hover { transform: translateY(-2px); box-shadow: 0 0 30px var(--primary-glow); }

        /* --- Reusable Components --- */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        .card { background: var(--bg-light); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); }
        .card h4 { color: var(--text-secondary); font-weight: 500; margin-bottom: 8px; }
        .card .value { font-size: 28px; font-weight: 700; color: var(--text-primary); }
        .card .value span { font-size: 16px; color: var(--text-secondary); }
        
        .table-container { background: var(--bg-light); border-radius: 12px; border: 1px solid var(--border-color); padding: 24px; }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .table-header input {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text-primary);
            width: 300px;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { color: var(--text-secondary); font-weight: 600; font-size: 14px; text-transform: uppercase; }
        
        /* Specific Table Styles */
        .status { font-weight: 600; text-transform: capitalize; }
        .status-in-transit { color: var(--secondary); }
        .status-delivered { color: var(--primary); }
        .status-pending { color: var(--text-secondary); }
        .status-in-stock { color: var(--success); }
        .status-low-stock { color: var(--warning); }
        .status-out-of-stock { color: var(--accent-pink); }
        
        .track-btn { background: var(--glass-bg); border: 1px solid var(--primary); color: var(--primary); padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        
        .product-cell { display: flex; align-items: center; }
        .product-img { width: 40px; height: 40px; border-radius: 8px; margin-right: 16px; object-fit: cover; background-color: var(--bg-dark); }
        .stock-bar { width: 100px; height: 8px; background-color: var(--glass-bg); border-radius: 4px; overflow: hidden; }
        .stock-bar-inner { height: 100%; background-color: var(--success); border-radius: 4px; }
        .stock-bar-inner.warning { background-color: var(--warning); }
        .stock-bar-inner.danger { background-color: var(--accent-pink); }

        /* --- Modal --- */
        .modal {
            position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(10, 9, 45, 0.7);
            backdrop-filter: blur(10px);
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--bg-light);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            position: relative;
            border: 1px solid var(--border-color);
        }
        .modal-content h2 { color: var(--primary); margin-top: 0; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 32px; font-weight: bold; cursor: pointer; color: var(--text-secondary); }
        .modal-form .input-group { margin-bottom: 16px; }
        .modal-form label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .modal-form input {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            font-size: 16px;
            color: var(--text-primary);
        }
        .modal-form button {
            width: 100%;
            margin-top: 16px;
        }

        #map { height: 400px; width: 100%; margin-top: 20px; border-radius: 8px; }
        .leaflet-container { background: var(--bg-light); }
        
        /* Skeleton Loader */
        .skeleton { opacity: .7; animation: skeleton-loading 1s linear infinite alternate; }
        @keyframes skeleton-loading {
            0% { background-color: hsl(230, 15%, 25%); }
            100% { background-color: hsl(230, 15%, 40%); }
        }
        .skeleton-text { width: 100%; height: 16px; margin-bottom: 4px; border-radius: 4px; }
        .skeleton-text:last-child { width: 80%; }

        /* --- Responsiveness --- */
        @media (max-width: 992px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar {
                grid-row: 2;
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                padding: 8px;
                border-top: 1px solid var(--border-color);
                position: fixed;
                bottom: 0;
                width: 100%;
                background: var(--bg-light);
                z-index: 100;
            }
            .sidebar-header, .sidebar-footer { display: none; }
            .sidebar-nav a { margin-bottom: 0; }
            .main-content { padding: 24px 16px 80px 16px; }
        }
        @media (max-width: 576px) {
            .analytics-grid { grid-template-columns: 1fr; }
            .table-header { flex-direction: column; align-items: stretch; }
            .table-header input { width: 100%; margin-top: 16px; }
        }
    </style>
</head>
<body>

    <!-- =========== LOGIN PAGE (Initial View) =========== -->
    <div id="login-page" class="page">
        <div class="login-wrapper">
            <div class="login-container">
                <h1>LogiNex</h1>
                <p>Intelligent Logistics for a Smarter Delhi</p>
                <form id="login-form">
                    <div class="input-group">
                        <input type="email" id="login-email" value="user@msme.com" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="login-password" value="password123" required>
                    </div>
                    <button type="submit">Access Dashboard</button>
                    <p class="error-message" id="login-error"></p>
                </form>
            </div>
        </div>
    </div>

    <!-- =========== MAIN APP LAYOUT (Hidden by default) =========== -->
    <div id="app-layout" class="app-layout hidden">
        <aside class="sidebar">
            <div class="sidebar-header">LogiNex</div>
            <nav class="sidebar-nav">
                <a href="#" class="active" data-page="dashboard">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                    Dashboard
                </a>
                <a href="#" data-page="inventory">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 16.5c.83 0 1.5-.67 1.5-1.5V6c0-1.1-.9-2-2-2H3.5c-.83 0-1.5.67-1.5 1.5v9c0 .83.67 1.5 1.5 1.5H15v4l4-4h2zm-9-4.5H4V7h8v5z"/></svg>
                    Inventory
                </a>
                <a href="#" data-page="analytics">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6h-6z"/></svg>
                    Analytics
                </a>
                <a href="#" data-page="settings">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                    Settings
                </a>
            </nav>
            <div class="sidebar-footer">
                <button id="logout-btn">Logout</button>
            </div>
        </aside>
        
        <main class="main-content">
            <!-- Dashboard Page Content -->
            <div id="dashboard-page" class="page">
                <header class="main-header">
                    <h2>Dashboard Overview</h2>
                    <button class="primary-action-btn" id="new-shipment-btn">+ Book New Shipment</button>
                </header>
                <section class="analytics-grid">
                    <div class="card"><h4>Total Shipments</h4><div class="value" id="stats-total-shipments">--</div></div>
                    <div class="card"><h4>On-Time Rate</h4><div class="value" id="stats-on-time-rate">--%</div></div>
                    <div class="card"><h4>Avg. Cost Saving</h4><div class="value" id="stats-avg-cost-saving">--%</div></div>
                    <div class="card"><h4>CO₂ Saved (Est.)</h4><div class="value" id="stats-co2-saved">-- <span>kg</span></div></div>
                </section>
                <section class="table-container">
                    <div class="table-header">
                        <h3>Recent Shipments</h3>
                        <input type="text" id="search-shipments" placeholder="Search by ID or Destination...">
                    </div>
                    <table>
                        <thead><tr><th>Shipment ID</th><th>Destination</th><th>Status</th><th>Date</th><th>Action</th></tr></thead>
                        <tbody id="shipment-list"></tbody>
                    </table>
                </section>
            </div>

            <!-- Inventory Page Content -->
            <div id="inventory-page" class="page hidden">
                <header class="main-header">
                    <h2>Inventory Portal</h2>
                    <button class="primary-action-btn" id="add-product-btn">+ Add New Product</button>
                </header>
                <section class="analytics-grid">
                    <div class="card"><h4>Total SKUs</h4><div class="value" id="inv-stats-total-skus">--</div></div>
                    <div class="card"><h4>Stock Value</h4><div class="value" id="inv-stats-stock-value">₹--</div></div>
                    <div class="card"><h4>Low Stock Items</h4><div class="value" id="inv-stats-low-stock">--</div></div>
                    <div class="card"><h4>Out of Stock</h4><div class="value" id="inv-stats-out-of-stock">--</div></div>
                </section>
                <section class="table-container">
                    <div class="table-header">
                        <h3>All Products</h3>
                        <input type="text" id="search-inventory" placeholder="Search by Product Name or SKU...">
                    </div>
                    <table>
                        <thead><tr><th>Product</th><th>SKU</th><th>Category</th><th>Stock on Hand</th><th>Status</th></tr></thead>
                        <tbody id="inventory-list"></tbody>
                    </table>
                </section>
            </div>
            
            <!-- Analytics Page Content -->
            <div id="analytics-page" class="page hidden">
                <header class="main-header">
                    <h2>Advanced Analytics</h2>
                </header>
                <section class="analytics-grid">
                    <div class="card" style="grid-column: 1 / -1;"><canvas id="shipments-over-time-chart"></canvas></div>
                    <div class="card"><canvas id="delivery-status-chart"></canvas></div>
                    <div class="card"><canvas id="stock-by-category-chart"></canvas></div>
                </section>
            </div>
        </main>
    </div>

    <!-- =========== MODALS =========== -->
    <div id="tracking-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" data-modal="tracking-modal">&times;</span>
            <h2>Live Shipment Tracking</h2>
            <p><strong>ID:</strong> <span id="tracking-shipment-id"></span> | <strong>Driver:</strong> <span id="tracking-driver-name"></span></p>
            <div id="map"></div>
        </div>
    </div>
    
    <div id="add-product-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" data-modal="add-product-modal">&times;</span>
            <h2>Add New Product to Inventory</h2>
            <form id="add-product-form" class="modal-form">
                <div class="input-group"><label for="product-name">Product Name</label><input type="text" id="product-name" required></div>
                <div class="input-group"><label for="product-sku">SKU</label><input type="text" id="product-sku" required></div>
                <div class="input-group"><label for="product-category">Category</label><input type="text" id="product-category" required></div>
                <div class="input-group"><label for="product-stock">Initial Stock</label><input type="number" id="product-stock" required></div>
                <div class="input-group"><label for="product-reorder">Reorder Point</label><input type="number" id="product-reorder" required></div>
                <button type="submit" class="primary-action-btn">Add Product</button>
            </form>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ELEMENT SELECTION ---
        const loginPage = document.getElementById('login-page');
        const appLayout = document.getElementById('app-layout');
        const mainContentPages = {
            dashboard: document.getElementById('dashboard-page'),
            inventory: document.getElementById('inventory-page'),
            analytics: document.getElementById('analytics-page'),
        };
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const sidebarNavLinks = document.querySelectorAll('.sidebar-nav a');
        const addProductBtn = document.getElementById('add-product-btn');
        const addProductModal = document.getElementById('add-product-modal');
        const addProductForm = document.getElementById('add-product-form');
        const trackingModal = document.getElementById('tracking-modal');
        
        // --- MOCK API & DATA ---
        let mockData = {
            shipments: [
               { id: 'DLNEX001', destination: 'Okhla Industrial Area, Phase 1', status: 'In Transit', date: '2025-08-04', driver: 'Ramesh Kumar', route: [[28.6139, 77.2090], [28.58, 77.25], [28.547, 77.274]] },
               { id: 'DLNEX002', destination: 'Bawana Industrial Area', status: 'Delivered', date: '2025-08-03', driver: 'Suresh Singh' },
               { id: 'DLNEX003', destination: 'Patparganj Industrial Area', status: 'Delivered', date: '2025-08-03', driver: 'Ramesh Kumar' },
               { id: 'DLNEX004', destination: 'Naraina Industrial Area', status: 'Pending', date: '2025-08-05', driver: 'Unassigned' },
            ],
            products: [
                { sku: 'TXT-BL-001', name: 'Blue Cotton Fabric Roll', category: 'Textiles', stock: 50, reorderPoint: 20, value: 5000, img: 'https://placehold.co/40x40/00fddc/0a092d?text=F' },
                { sku: 'MCH-PT-012', name: 'CNC Machine Part #12', category: 'Machinery', stock: 15, reorderPoint: 10, value: 12000, img: 'https://placehold.co/40x40/9e77f8/0a092d?text=M' },
                { sku: 'PLST-GR-005', name: 'Green Plastic Granules', category: 'Plastics', stock: 8, reorderPoint: 15, value: 2500, img: 'https://placehold.co/40x40/00e676/0a092d?text=P' },
                { sku: 'PCK-BX-003', name: 'Cardboard Box (Large)', category: 'Packaging', stock: 0, reorderPoint: 50, value: 150, img: 'https://placehold.co/40x40/ff3b81/0a092d?text=B' },
            ]
        };
        
        const mockApi = {
            login: async (email, password) => new Promise(res => setTimeout(() => res(email === 'user@msme.com' && password === 'password123' ? { success: true, token: 'fake-jwt-token' } : { success: false, message: 'Invalid credentials' }), 1000)),
            getDashboardData: async (token) => new Promise(res => setTimeout(() => res({
                success: true,
                stats: { totalShipments: mockData.shipments.length, onTimeRate: 98.5, avgCostSaving: 22.3, co2Saved: 78.4 },
                shipments: mockData.shipments
            }), 1000)),
            getInventoryData: async (token) => new Promise(res => setTimeout(() => {
                const stockValue = mockData.products.reduce((sum, p) => sum + (p.stock * p.value), 0);
                const lowStock = mockData.products.filter(p => p.stock > 0 && p.stock <= p.reorderPoint).length;
                const outOfStock = mockData.products.filter(p => p.stock === 0).length;
                res({
                    success: true,
                    stats: { totalSKUs: mockData.products.length, stockValue, lowStock, outOfStock },
                    products: mockData.products
                });
            }, 500)),
            getAnalyticsData: async (token) => new Promise(res => setTimeout(() => res({
                success: true,
                shipmentsOverTime: {
                    labels: ['May', 'Jun', 'Jul', 'Aug'],
                    data: [80, 105, 120, 134]
                },
                deliveryStatus: {
                    labels: ['Delivered', 'In Transit', 'Pending'],
                    data: [mockData.shipments.filter(s=>s.status==='Delivered').length, mockData.shipments.filter(s=>s.status==='In Transit').length, mockData.shipments.filter(s=>s.status==='Pending').length]
                },
                stockByCategory: {
                    labels: [...new Set(mockData.products.map(p => p.category))],
                    data: [...new Set(mockData.products.map(p => p.category))].map(cat => mockData.products.filter(p=>p.category===cat).reduce((sum, p) => sum + p.stock, 0))
                }
            }), 500)),
            createProduct: async (token, product) => new Promise(res => setTimeout(() => {
                mockData.products.unshift(product);
                res({ success: true, product });
            }, 500))
        };

        // --- APP STATE ---
        let state = { authToken: null, currentPage: 'dashboard' };
        let charts = {};
        let map;

        // --- UI RENDER FUNCTIONS ---
        const showAppPage = (pageKey) => {
            Object.values(mainContentPages).forEach(p => p.classList.add('hidden'));
            if(mainContentPages[pageKey]) {
                mainContentPages[pageKey].classList.remove('hidden');
                state.currentPage = pageKey;
                updateActiveNavLink();
                loadPageData(pageKey);
            }
        };

        const updateActiveNavLink = () => sidebarNavLinks.forEach(link => link.classList.toggle('active', link.dataset.page === state.currentPage));
        
        const loadPageData = (pageKey) => {
            if (pageKey === 'dashboard') renderDashboard();
            if (pageKey === 'inventory') renderInventory();
            if (pageKey === 'analytics') renderAnalytics();
        };

        const renderDashboard = async () => {
            const shipmentListBody = document.getElementById('shipment-list');
            shipmentListBody.innerHTML = getSkeletonHTML(5, 5);
            const data = await mockApi.getDashboardData(state.authToken);
            if (data.success) {
                document.getElementById('stats-total-shipments').textContent = data.stats.totalShipments;
                document.getElementById('stats-on-time-rate').textContent = `${data.stats.onTimeRate}%`;
                document.getElementById('stats-avg-cost-saving').textContent = `${data.stats.avgCostSaving}%`;
                document.getElementById('stats-co2-saved').textContent = `${data.stats.co2Saved}`;
                renderTable(shipmentListBody, data.shipments, getShipmentRowHTML);
            }
        };

        const renderInventory = async () => {
            const inventoryListBody = document.getElementById('inventory-list');
            inventoryListBody.innerHTML = getSkeletonHTML(5, 5);
            const data = await mockApi.getInventoryData(state.authToken);
            if (data.success) {
                document.getElementById('inv-stats-total-skus').textContent = data.stats.totalSKUs;
                document.getElementById('inv-stats-stock-value').textContent = `₹${data.stats.stockValue.toLocaleString('en-IN')}`;
                document.getElementById('inv-stats-low-stock').textContent = data.stats.lowStock;
                document.getElementById('inv-stats-out-of-stock').textContent = data.stats.outOfStock;
                renderTable(inventoryListBody, data.products, getInventoryRowHTML);
            }
        };
        
        const renderAnalytics = async () => {
            const data = await mockApi.getAnalyticsData(state.authToken);
            if(data.success) {
                createChart('shipments-over-time-chart', 'line', data.shipmentsOverTime, 'Shipments per Month');
                createChart('delivery-status-chart', 'doughnut', data.deliveryStatus, 'Delivery Status');
                createChart('stock-by-category-chart', 'bar', data.stockByCategory, 'Stock by Category');
            }
        };

        const renderTable = (tbody, data, rowTemplateFn) => {
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--text-secondary);">No data found.</td></tr>`;
                return;
            }
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = rowTemplateFn(item);
                tbody.appendChild(row);
            });
        };
        
        const getSkeletonHTML = (rows, cols) => Array(rows).fill(`<tr><td colspan="${cols}"><div class="skeleton skeleton-text"></div></td></tr>`).join('');

        const getShipmentRowHTML = (shipment) => `<td>${shipment.id}</td><td>${shipment.destination}</td><td><span class="status status-${shipment.status.toLowerCase().replace(/\s+/g, '-')}">${shipment.status}</span></td><td>${shipment.date}</td><td>${shipment.status === 'In Transit' ? `<button class="track-btn" data-id="${shipment.id}">Track</button>` : '-'}</td>`;

        const getInventoryRowHTML = (product) => {
            let statusClass = 'in-stock';
            let stockPercentage = Math.min(100, (product.stock / (product.reorderPoint * 1.5)) * 100);
            if (product.stock === 0) { statusClass = 'out-of-stock'; stockPercentage = 0; }
            else if (product.stock <= product.reorderPoint) { statusClass = 'low-stock'; }
            let barClass = 'success';
            if (statusClass === 'low-stock') barClass = 'warning';
            if (statusClass === 'out-of-stock') barClass = 'danger';
            return `<td><div class="product-cell"><img src="${product.img}" class="product-img" onerror="this.style.display='none'"> ${product.name}</div></td><td>${product.sku}</td><td>${product.category}</td><td><div style="display: flex; align-items: center; gap: 8px;"><span>${product.stock}</span><div class="stock-bar"><div class="stock-bar-inner ${barClass}" style="width: ${stockPercentage}%"></div></div></div></td><td><span class="status status-${statusClass}">${statusClass.replace('-', ' ')}</span></td>`;
        };
        
        const createChart = (canvasId, type, chartData, title) => {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (charts[canvasId]) charts[canvasId].destroy();
            
            const options = {
                responsive: true,
                plugins: { legend: { labels: { color: 'white' } }, title: { display: true, text: title, color: 'white' } },
                scales: type === 'line' || type === 'bar' ? {
                    x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                    y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                } : {}
            };
            
            let datasetOptions = {};
            if (type === 'line') datasetOptions = { borderColor: 'var(--primary)', backgroundColor: 'var(--primary-glow)', fill: true, tension: 0.4 };
            if (type === 'doughnut') datasetOptions = { backgroundColor: ['#00fddc', '#9e77f8', '#a9b2d8'], borderColor: 'var(--bg-light)' };
            if (type === 'bar') datasetOptions = { backgroundColor: 'var(--secondary)' };

            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: { labels: chartData.labels, datasets: [{ label: title, data: chartData.data, ...datasetOptions }] },
                options: options
            });
        };

        const openTrackingModal = (shipmentId) => {
            const shipment = mockData.shipments.find(s => s.id === shipmentId);
            if (!shipment) return;

            document.getElementById('tracking-shipment-id').textContent = shipment.id;
            document.getElementById('tracking-driver-name').textContent = shipment.driver;
            trackingModal.classList.remove('hidden');

            if (map) map.remove();
            map = L.map('map').setView([28.6139, 77.2090], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO'
            }).addTo(map);

            if (shipment.route) {
                L.polyline(shipment.route, { color: 'var(--primary)', weight: 4, opacity: 0.8 }).addTo(map);
                map.fitBounds(L.polyline(shipment.route).getBounds().pad(0.1));
            }
        };

        // --- EVENT LISTENERS ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const res = await mockApi.login(document.getElementById('login-email').value, document.getElementById('login-password').value);
            if (res.success) {
                state.authToken = res.token;
                loginPage.classList.add('hidden');
                appLayout.classList.remove('hidden');
                showAppPage('dashboard');
            } else {
                document.getElementById('login-error').textContent = res.message;
            }
        });

        logoutBtn.addEventListener('click', () => {
            state.authToken = null;
            loginPage.classList.remove('hidden');
            appLayout.classList.add('hidden');
        });
        
        sidebarNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showAppPage(link.dataset.page);
            });
        });
        
        addProductBtn.addEventListener('click', () => addProductModal.classList.remove('hidden'));
        
        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newProduct = {
                sku: document.getElementById('product-sku').value,
                name: document.getElementById('product-name').value,
                category: document.getElementById('product-category').value,
                stock: parseInt(document.getElementById('product-stock').value),
                reorderPoint: parseInt(document.getElementById('product-reorder').value),
                value: 0, // Not in form for simplicity
                img: `https://placehold.co/40x40/cccccc/0a092d?text=${document.getElementById('product-name').value.charAt(0)}`
            };
            const res = await mockApi.createProduct(state.authToken, newProduct);
            if(res.success) {
                addProductModal.classList.add('hidden');
                addProductForm.reset();
                renderInventory();
            }
        });
        
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.getElementById(e.target.dataset.modal).classList.add('hidden');
            });
        });

        appLayout.addEventListener('click', (e) => {
            if (e.target.classList.contains('track-btn')) {
                openTrackingModal(e.target.dataset.id);
            }
        });

    });
    </script>
</body>
</html>
