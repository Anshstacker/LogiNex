<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LogiNex Driver App (Enhanced)</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- Design System & Variables --- */
        :root {
            --bg-dark: #0a092d;
            --bg-light: #101c42;
            --primary: #00fddc;
            --primary-glow: rgba(0, 253, 220, 0.4);
            --secondary: #9e77f8;
            --text-primary: #ffffff;
            --text-secondary: #a9b2d8;
            --border-color: rgba(169, 178, 216, 0.1);
            --glass-bg: rgba(16, 28, 66, 0.7);
            --success: #00e676;
            --danger: #ff3b81;
            --shadow: 0px 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* --- Base & Reset --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { -webkit-text-size-adjust: 100%; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .hidden { display: none !important; }

        /* --- App Shell --- */
        .app-shell {
            max-width: 450px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--bg-dark);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        .page { width: 100%; height: 100%; display: flex; flex-direction: column; flex-grow: 1; }

        /* --- Login Page --- */
        .login-page {
            justify-content: center;
            align-items: center;
            padding: 24px;
            background: linear-gradient(180deg, var(--bg-light) 0%, var(--bg-dark) 100%);
        }
        .login-container { width: 100%; text-align: center; }
        .login-container h1 { font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .login-container p { color: var(--text-secondary); margin-bottom: 48px; }
        .input-group { margin-bottom: 20px; }
        .input-group input {
            width: 100%;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
        }
        .input-group input::placeholder { color: var(--text-secondary); }
        .primary-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: var(--bg-dark);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 25px var(--primary-glow);
        }
        .primary-btn:hover { transform: translateY(-2px); box-shadow: 0 0 35px var(--primary-glow); }
        .error-message { color: var(--danger); min-height: 20px; font-size: 14px; margin-top: 16px; }

        /* --- Job List Page --- */
        .job-list-page header { padding: 20px; background: var(--bg-light); border-bottom: 1px solid var(--border-color); }
        .profile-header { display: flex; align-items: center; justify-content: space-between; }
        .profile-info h2 { font-size: 22px; font-weight: 600; }
        .profile-info p { color: var(--text-secondary); font-size: 14px; }
        .logout-btn { background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary); width: 40px; height: 40px; border-radius: 50%; font-size: 18px; cursor: pointer; }
        .route-summary { margin-top: 20px; padding: 16px; background: var(--glass-bg); border-radius: 12px; text-align: center; }
        .route-summary h3 { font-size: 18px; font-weight: 600; color: var(--primary); }
        .route-summary p { color: var(--text-secondary); font-size: 14px; }

        .job-list { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .job-timeline-item { display: flex; }
        .timeline-connector { display: flex; flex-direction: column; align-items: center; margin-right: 16px; }
        .timeline-dot { width: 20px; height: 20px; border-radius: 50%; background-color: var(--secondary); border: 3px solid var(--bg-light); }
        .timeline-line { flex-grow: 1; width: 3px; background-color: var(--bg-light); }
        .job-timeline-item:last-child .timeline-line { background: transparent; }
        .job-timeline-item.pickup .timeline-dot { background-color: var(--primary); }
        .job-timeline-item.completed .timeline-dot { background-color: var(--success); }

        .job-card {
            flex-grow: 1;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .job-card:hover { transform: scale(1.02); }
        .job-timeline-item.completed .job-card { opacity: 0.6; }
        .job-details h4 { font-size: 16px; font-weight: 600; }
        .job-details p { font-size: 14px; color: var(--text-secondary); }
        .job-status { margin-left: auto; font-size: 24px; color: var(--text-secondary); }
        .job-timeline-item.completed .job-status { color: var(--success); }

        /* --- Job Detail Page --- */
        .job-detail-page { background: var(--bg-light); }
        .map-container { position: relative; height: 40vh; background-color: #000; }
        #map { height: 100%; width: 100%; }
        .back-btn { position: absolute; top: 20px; left: 20px; z-index: 1000; background: var(--glass-bg); border: 1px solid var(--border-color); color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; }
        
        .details-panel {
            flex-grow: 1;
            background: var(--bg-dark);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 24px;
            transform: translateY(-20px);
            display: flex;
            flex-direction: column;
        }
        .details-header { display: flex; align-items: center; margin-bottom: 24px; }
        .details-header .job-icon { font-size: 32px; margin-right: 16px; }
        .details-header h2 { font-size: 20px; font-weight: 600; }
        .detail-item { display: flex; align-items: center; margin-bottom: 16px; }
        .detail-item .icon { width: 40px; text-align: center; font-size: 20px; color: var(--text-secondary); }
        .detail-item p { flex-grow: 1; }
        
        .actions { margin-top: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .secondary-btn { padding: 16px; background: var(--bg-light); color: var(--primary); border: 1px solid var(--primary); border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(10, 9, 45, 0.7);
            backdrop-filter: blur(10px);
            display: flex; justify-content: center; align-items: center;
            padding: 20px;
        }
        .modal-content {
            background: var(--bg-light);
            padding: 24px;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            position: relative;
            border: 1px solid var(--border-color);
            text-align: center;
        }
        .modal-content h3 { margin-bottom: 20px; color: var(--primary); }
        .close-modal-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; }
        
        #signature-pad { border: 1px solid var(--border-color); border-radius: 8px; cursor: crosshair; }
        .signature-actions { display: flex; gap: 10px; margin-top: 16px; }
        #clear-signature, #save-signature { width: 100%; }
        
        #camera-feed { width: 100%; border-radius: 8px; }
        #photo-canvas { display: none; }
    </style>
</head>
<body>

    <div class="app-shell">
        <!-- =========== LOGIN PAGE =========== -->
        <div id="login-page" class="page login-page">
            <div class="login-container">
                <h1>LogiNex</h1>
                <p>Driver Portal</p>
                <form id="login-form">
                    <div class="input-group">
                        <input type="text" id="login-username" value="ramesh.k" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="login-password" value="password123" required>
                    </div>
                    <button type="submit" class="primary-btn">Login</button>
                    <p class="error-message" id="login-error"></p>
                </form>
            </div>
        </div>

        <!-- =========== JOB LIST PAGE =========== -->
        <div id="job-list-page" class="page job-list-page hidden">
            <header>
                <div class="profile-header">
                    <div class="profile-info">
                        <h2>Ramesh Kumar</h2>
                        <p>Vehicle: DL 1A B 1234</p>
                    </div>
                    <button class="logout-btn" id="logout-btn">⏻</button>
                </div>
                <div class="route-summary">
                    <h3>Today's Optimized Route</h3>
                    <p><span id="total-stops"></span> Stops | Est. <span id="total-time"></span></p>
                </div>
            </header>
            <main class="job-list" id="job-list-container">
                <!-- Job cards will be injected here -->
            </main>
        </div>
        
        <!-- =========== JOB DETAIL PAGE =========== -->
        <div id="job-detail-page" class="page job-detail-page hidden">
            <header class="map-container">
                <button class="back-btn" id="back-to-list-btn">←</button>
                <div id="map"></div>
            </header>
            <main class="details-panel">
                <div class="details-header">
                    <div class="job-icon" id="detail-job-icon"></div>
                    <h2 id="detail-job-title"></h2>
                </div>
                <div class="detail-item"><span class="icon">📍</span><p id="detail-job-address"></p></div>
                <div class="detail-item"><span class="icon">👤</span><p id="detail-job-contact"></p></div>
                <div class="detail-item"><span class="icon">📦</span><p id="detail-job-notes"></p></div>
                <div class="actions">
                    <button class="secondary-btn" id="navigate-btn">Navigate</button>
                    <button class="primary-btn" id="complete-btn">Mark as Complete</button>
                </div>
            </main>
        </div>

        <!-- =========== MODALS =========== -->
        <div id="signature-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <button class="close-modal-btn" data-modal="signature-modal">&times;</button>
                <h3>Step 1: Capture Signature</h3>
                <canvas id="signature-pad" width="300" height="150"></canvas>
                <div class="signature-actions">
                    <button id="clear-signature" class="secondary-btn">Clear</button>
                    <button id="save-signature" class="primary-btn">Next: Take Photo</button>
                </div>
            </div>
        </div>
        
        <div id="photo-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <button class="close-modal-btn" data-modal="photo-modal">&times;</button>
                <h3>Step 2: Proof of Delivery Photo</h3>
                <video id="camera-feed" autoplay playsinline></video>
                <canvas id="photo-canvas"></canvas>
                <button id="capture-photo-btn" class="primary-btn" style="margin-top: 16px;">Capture & Finish Job</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- PAGE ELEMENTS ---
        const pages = {
            login: document.getElementById('login-page'),
            jobList: document.getElementById('job-list-page'),
            jobDetail: document.getElementById('job-detail-page'),
        };
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const jobListContainer = document.getElementById('job-list-container');
        const backToListBtn = document.getElementById('back-to-list-btn');

        // Modals & Proof of Delivery
        const signatureModal = document.getElementById('signature-modal');
        const photoModal = document.getElementById('photo-modal');
        const videoFeed = document.getElementById('camera-feed');
        const photoCanvas = document.getElementById('photo-canvas');
        const capturePhotoBtn = document.getElementById('capture-photo-btn');

        // --- MOCK DATA ---
        let jobs = [
            { id: 1, type: 'pickup', company: 'ABC Textiles', address: 'A-24, Okhla Industrial Area, Phase 1, New Delhi', contact: 'Mr. Sharma', notes: '2 Large boxes, use Gate 2.', status: 'pending', coords: [28.535, 77.28] },
            { id: 2, type: 'delivery', company: 'XYZ Components', address: 'Plot 112, Sector 5, Bawana Industrial Area, Delhi', contact: 'Sunita Singh', notes: 'Deliver to warehouse reception.', status: 'pending', coords: [28.80, 77.05] },
            { id: 3, type: 'delivery', company: 'Mehra Prints', address: 'C-5, Patparganj Industrial Area, Delhi', contact: 'Anil Mehra', notes: 'Fragile items. Handle with care.', status: 'pending', coords: [28.63, 77.30] },
            { id: 4, type: 'pickup', company: 'Delhi Steel Corp', address: 'B-101, Naraina Industrial Area, Phase 1, New Delhi', contact: 'Office', notes: 'Heavy items. Trolley required.', status: 'pending', coords: [28.62, 77.14] }
        ];
        let currentJobId = null;
        let cameraStream = null;

        // --- APP LOGIC ---
        const showPage = (pageName) => {
            Object.values(pages).forEach(page => page.classList.add('hidden'));
            pages[pageName].classList.remove('hidden');
        };

        const renderJobList = () => {
            jobListContainer.innerHTML = '';
            jobs.forEach(job => {
                const item = document.createElement('div');
                item.className = job-timeline-item ${job.type} ${job.status};
                
                let icon = job.type === 'pickup' ? '🔼' : '🔽';
                let statusIcon = job.status === 'completed' ? '✅' : '❯';

                item.innerHTML = `
                    <div class="timeline-connector">
                        <div class="timeline-dot"></div>
                        <div class="timeline-line"></div>
                    </div>
                    <div class="job-card" data-job-id="${job.id}">
                        <div class="job-details">
                            <h4>${job.company}</h4>
                            <p>${job.address}</p>
                        </div>
                        <div class="job-status">${statusIcon}</div>
                    </div>
                `;

                if (job.status !== 'completed') {
                    item.querySelector('.job-card').addEventListener('click', () => showJobDetail(job.id));
                }
                jobListContainer.appendChild(item);
            });
            document.getElementById('total-stops').textContent = jobs.length;
            document.getElementById('total-time').textContent = '4h 30m';
        };

        const showJobDetail = (jobId) => {
            currentJobId = jobId;
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;

            document.getElementById('detail-job-icon').textContent = job.type === 'pickup' ? '🔼' : '🔽';
            document.getElementById('detail-job-title').textContent = job.company;
            document.getElementById('detail-job-address').textContent = job.address;
            document.getElementById('detail-job-contact').textContent = job.contact;
            document.getElementById('detail-job-notes').textContent = job.notes;
            
            document.getElementById('navigate-btn').onclick = () => window.open(https://www.google.com/maps/dir/?api=1&destination=${job.coords.join(',')}, '_blank');
            document.getElementById('complete-btn').onclick = () => signatureModal.classList.remove('hidden');

            showPage('jobDetail');
            setupSignaturePad();
            
            const map = L.map('map').setView(job.coords, 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }).addTo(map);
            L.marker(job.coords).addTo(map);
        };

        const completeJob = () => {
            const job = jobs.find(j => j.id === currentJobId);
            if (job) job.status = 'completed';
            renderJobList();
            showPage('jobList');
        };

        // --- PROOF OF DELIVERY FLOW ---
        const setupSignaturePad = () => {
            const canvas = document.getElementById('signature-pad');
            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = 'var(--primary)';
            ctx.lineWidth = 3;
            let drawing = false;

            const clearCanvas = () => ctx.clearRect(0, 0, canvas.width, canvas.height);
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                return [ (e.clientX || e.touches[0].clientX) - rect.left, (e.clientY || e.touches[0].clientY) - rect.top ];
            };
            const startDrawing = (e) => { drawing = true; draw(e); };
            const stopDrawing = () => { drawing = false; ctx.beginPath(); };
            const draw = (e) => {
                if (!drawing) return;
                const [x, y] = getPos(e);
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            };

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchmove', draw, { passive: false });

            document.getElementById('clear-signature').onclick = clearCanvas;
            document.getElementById('save-signature').onclick = () => {
                signatureModal.classList.add('hidden');
                openCamera();
            };
        };

        const openCamera = async () => {
            photoModal.classList.remove('hidden');
            try {
                const constraints = { video: { facingMode: "environment" } };
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoFeed.srcObject = cameraStream;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                alert("Could not access camera. Please ensure you have given permission.");
                photoModal.classList.add('hidden');
            }
        };

        const stopCamera = () => {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        };

        capturePhotoBtn.addEventListener('click', () => {
            const context = photoCanvas.getContext('2d');
            photoCanvas.width = videoFeed.videoWidth;
            photoCanvas.height = videoFeed.videoHeight;
            context.drawImage(videoFeed, 0, 0, videoFeed.videoWidth, videoFeed.videoHeight);
            // In a real app, you would upload this image data
            // const imageData = photoCanvas.toDataURL('image/png');
            alert('Photo captured! Finishing job.');
            
            stopCamera();
            photoModal.classList.add('hidden');
            completeJob();
        });

        // --- EVENT LISTENERS ---
        loginForm.addEventListener('submit', (e) => { e.preventDefault(); showPage('jobList'); renderJobList(); });
        logoutBtn.addEventListener('click', () => showPage('login'));
        backToListBtn.addEventListener('click', () => showPage('jobList'));
        
        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const modalId = btn.dataset.modal;
                document.getElementById(modalId).classList.add('hidden');
                if (modalId === 'photo-modal') stopCamera();
            });
        });

        // --- INITIALIZATION ---
        showPage('login');
    });
    </script>
</body>
</html>
